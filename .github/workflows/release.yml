name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  # Toggle to enable PGO+BOLT on Linux builds. Defaults off to keep CI fast/stable.
  ENABLE_PGO_BOLT: "false"
  # Toggle x86-64-v4 builds (some crates may not support v4).
  ENABLE_X86_64_V4: "false"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Run rasterizeddb_core tests
        run: cargo test -p rasterizeddb_core

  build-and-upload:
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target_cpu: x86-64-v3
            artifact_name: rasterizeddb_server-linux-x64-v3
            bin_path: target/release/rasterizeddb_core
            rustflags: "-C link-arg=-Wl,-zstack-size=33554432 -C target-cpu=x86-64-v3"
          - os: ubuntu-latest
            target_cpu: x86-64-v4
            artifact_name: rasterizeddb_server-linux-x64-v4
            bin_path: target/release/rasterizeddb_core
            rustflags: "-C link-arg=-Wl,-zstack-size=33554432 -C target-cpu=x86-64-v4"
          - os: windows-latest
            target_cpu: x86-64-v3
            artifact_name: rasterizeddb_server-windows-x64-v3.exe
            bin_path: target/release/rasterizeddb_core.exe
            rustflags: "-C link-arg=/STACK:33554432 -C target-cpu=x86-64-v3"
          - os: windows-latest
            target_cpu: x86-64-v4
            artifact_name: rasterizeddb_server-windows-x64-v4.exe
            bin_path: target/release/rasterizeddb_core.exe
            rustflags: "-C link-arg=/STACK:33554432 -C target-cpu=x86-64-v4"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Install llvm-tools (for optional PGO/BOLT)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        run: rustup component add llvm-tools-preview

      - name: Install perf and BOLT tooling (Linux only)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        run: sudo apt-get update && sudo apt-get install -y linux-tools-common linux-tools-generic llvm-18-tools

      - name: Build (standard)
        if: (env.ENABLE_PGO_BOLT != 'true' || matrix.os != 'ubuntu-latest') && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
        run: cargo build --release -p rasterizeddb_core

      - name: Build with PGO instrumentation (Linux optional)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        env:
          RUSTFLAGS: ${{ matrix.rustflags }} -Cprofile-generate=./pgo-data
        run: cargo build --release -p rasterizeddb_core

      - name: Run workload to collect profiles (Linux optional)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        run: cargo test -p rasterizeddb_core --release -- --nocapture

      - name: Merge PGO profiles (Linux optional)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        run: |
          PROFDATA_BIN="$(rustc --print target-libdir)/../bin/llvm-profdata"
          "$PROFDATA_BIN" merge -output=pgo-data.profdata pgo-data

      - name: Build with PGO profile-use (Linux optional)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        env:
          RUSTFLAGS: ${{ matrix.rustflags }} -Cprofile-use=./pgo-data.profdata -Cllvm-args=-pgo-warn-missing-function
        run: cargo build --release -p rasterizeddb_core

      - name: Collect perf data for BOLT (Linux optional)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        run: |
          sudo perf record -e cycles:u -j any,u -o perf.data -- ${{ matrix.bin_path }} --help

      - name: Apply BOLT (Linux optional)
        if: env.ENABLE_PGO_BOLT == 'true' && matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        run: |
          perf2bolt ${{ matrix.bin_path }} -p perf.data -o perf.fdata
          llvm-bolt ${{ matrix.bin_path }} -o ${{ matrix.bin_path }}.bolt -data=perf.fdata --reorder-blocks=ext-tsp --reorder-functions=hfsort+ --split-functions --dyno-stats
          mv ${{ matrix.bin_path }}.bolt ${{ matrix.bin_path }}

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        shell: pwsh
        run: Copy-Item ${{ matrix.bin_path }} ${{ matrix.artifact_name }}

      - name: Prepare artifact (Linux)
        if: matrix.os == 'ubuntu-latest' && (matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true')
        run: cp ${{ matrix.bin_path }} ${{ matrix.artifact_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}
          if-no-files-found: error
        if: matrix.target_cpu != 'x86-64-v4' || env.ENABLE_X86_64_V4 == 'true'

  release:
    needs: [build-and-upload]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: rasterizeddb_server-*
          merge-multiple: true

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/rasterizeddb_server-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}